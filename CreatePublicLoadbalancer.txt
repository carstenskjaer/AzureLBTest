az group create --name lbtest-rg --location northeurope
az network vnet create --resource-group lbtest-rg --location northeurope --name lbtest-vnet --address-prefixes 10.1.0.0/16 --subnet-name lbtest-subnet --subnet-prefixes 10.1.0.0/24
az network public-ip create --resource-group lbtest-rg --name lbtest-bastion-ip --sku Basic
az network vnet subnet create --resource-group lbtest-rg --name AzureBastionSubnet --vnet-name lbtest-vnet --address-prefixes 10.1.1.0/24
az network bastion create --resource-group lbtest-rg --name lbtest-bastion-host --public-ip-address lbtest-bastion-ip --vnet-name lbtest-vnet --location northeurope
az network nsg create --resource-group lbtest-rg --name lbtest-nsg
az network nsg rule create --resource-group lbtest-rg --nsg-name lbtest-nsg --name lbtest-nsg-rule-http --protocol '*' --direction inbound --source-address-prefix '*' --source-port-range '*' --destination-address-prefix '*' --destination-port-range 80 --access allow --priority 200

nics_array=(lbtest-nic-vm1 lbtest-nic-vm2 lbtest-nic-vm3)
  for vmnic in "${nics_array[@]}"
  do
    az network nic create \
        --resource-group lbtest-rg \
        --name $vmnic \
        --vnet-name lbtest-vnet \
        --subnet lbtest-subnet \
        --network-security-group lbtest-nsg
  done

az vm availability-set create --name lbtest-avset --resource-group lbtest-rg --location northeurope

az vm create --resource-group lbtest-rg --name lbtest-vm1 --nics lbtest-nic-vm1 --image win2019datacenter --admin-username azureuser --availability-set lbtest-avset --no-wait --admin-password lbtest-AdminPW123!
az vm create --resource-group lbtest-rg --name lbtest-vm2 --nics lbtest-nic-vm2 --image win2019datacenter --admin-username azureuser --availability-set lbtest-avset --no-wait --admin-password lbtest-AdminPW123!
az vm create --resource-group lbtest-rg --name lbtest-vm3 --nics lbtest-nic-vm3 --image win2019datacenter --admin-username azureuser --availability-set lbtest-avset --no-wait --admin-password lbtest-AdminPW123!

az network public-ip create --resource-group lbtest-rg --name lbtest-public-ip --sku Basic

az network lb create --resource-group lbtest-rg --name lbtest-loadbalancer --sku Basic --public-ip-address lbtest-public-ip --frontend-ip-name lbtest-frontend-ip-name --backend-pool-name lbtest-backend-pool
az network lb probe create --resource-group lbtest-rg --lb-name lbtest-loadbalancer --name lbtest-health-probe --protocol tcp --port 80   
az network lb rule create --resource-group lbtest-rg --lb-name lbtest-loadbalancer --name lbtest-http-rule --protocol tcp --frontend-port 80 --backend-port 80 --frontend-ip-name lbtest-frontend-ip-name --backend-pool-name lbtest-backend-pool --probe-name lbtest-health-probe --idle-timeout 15

for vmnic in "${nics_array[@]}"
do
az network nic ip-config address-pool add \
    --address-pool lbtest-backend-pool \
    --ip-config-name ipconfig1 \
    --nic-name $vmnic \
    --resource-group lbtest-rg \
    --lb-name lbtest-loadbalancer
done

vms_array=(lbtest-vm1 lbtest-vm2 lbtest-vm3)
for vm in "${vms_array[@]}"
do
    az vm extension set \
    --publisher Microsoft.Compute \
    --version 1.8 \
    --name CustomScriptExtension \
    --vm-name $vm \
    --resource-group lbtest-rg \
    --settings '{"commandToExecute":"powershell Add-WindowsFeature Web-Server; powershell Add-Content -Path \"C:\\inetpub\\wwwroot\\Default.htm\" -Value $($env:computername)"}'
done

az network public-ip show --resource-group lbtest-rg --name lbtest-public-ip --query ipAddress --output tsv

az group delete --name lbtest-rg
